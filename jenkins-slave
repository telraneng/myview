FROM jenkinsci/slave:latest
USER root
RUN apt-get update && \
    apt-get -y install apt-transport-https \
    ca-certificates \
    curl \
    gnupg2 \
    software-properties-common && \
    curl -fsSL https://download.docker.com/linux/$(. /etc/os-release; echo "$ID")/gpg > /tmp/dkey; apt-key add /tmp/dkey && \
    add-apt-repository \
    "deb [arch=amd64] https://download.docker.com/linux/$(. /etc/os-release; echo "$ID") \
    $(lsb_release -cs) \
    stable" && \
    apt-get update && \
    apt-get -y install docker-ce
RUN usermod -a -G docker jenkins
RUN apt-get update && apt-get install -y python-pip
RUN pip install ansible
RUN mkdir -p /home/jenkins/.ansible && \
    mkdir -p /home/jenkins/.ssh && \
    chown -R 1000:1000 /home/jenkins/.ansible && \
    chown -R 1000:1000 /home/jenkins/.ssh

COPY get_helm.sh /scripts/get_helm.sh
COPY config /home/jenkins/config
COPY certs/harbor.orbotech.org/ca.crt /etc/ssl/certs/ca.crt
COPY certs/cert.pem /home/jenkins/.docker/cert.pem
COPY certs/ca.pem /home/jenkins/.docker/ca.pem
COPY certs/key.pem /home/jenkins/.docker/key.pem
COPY certs/cert.pem /root/.docker/cert.pem
COPY certs/ca.pem /root/.docker/ca.pem
COPY certs/key.pem /root/.docker/key.pem
ENV KUBECONFIG=/home/jenkins/config
RUN /scripts/get_helm.sh -v v2.16.1
RUN helm init --client-only
RUN helm plugin install https://github.com/chartmuseum/helm-push

WORKDIR /home/jenkins

ENV JENKINS_URL "https://jenkins-adc.orbotech.org:8443/"
ENV JENKINS_SLAVE_ADDRESS ""
ENV JENKINS_USER "Buildbot"
ENV JENKINS_PASS "Q!W@E#R$t5y6~"
ENV SLAVE_LABELS "node-docker"
ENV SLAVE_EXECUTORS "1"
ENV CLEAN_WORKING_DIR "true"
